<!DOCTYPE html>
<html>
<head>
	<title></title>
	<style type="text/css">
		canvas { border:1px solid #000; }
	</style>
</head>

<body>

<canvas id="test" width="600" height="400"></canvas>

<script type="text/javascript">

(function(w){

function _ext(a, b){	// a -> b
	if(!b) b = {};
	if(!a) return b;
	for(var p in a){
		if(typeof a[p] === 'object'){
			b[p] = _ext(a[p], b[p]);
		} else {
			b[p] = a[p]
		}
	}
	return b;
}
function _inherit(name, base, extra, init){
	eval('var fn = function ' + (name || '___') + '(){'
		+ 'base.apply(this, Array.prototype.slice.call(arguments, 0));'
		+ '_ext(init, this);'
		+ '}');
	_ext(extra, fn.prototype = new base());
	return fn;
}

function cvsEventObject(target){
	this.hash = {};
	this.target = target;
}
cvsEventObject.prototype = {
	regist : function(eventName, callback){
		if(!this.hash[eventName]){
			this.hash[eventName] = [];
		}
		this.hash[eventName].push(callback);
	},
	fire : function(eventName){
		if(!this.hash[eventName]) return;
		var i = this.hash[eventName].length;
		while(--i >= 0){
			this.hash[eventName].call(this.target);
		}
	}
}

function CanvasGenericElement(config){
	this.parent = null;
	this.children = [];
	this.image = null;
	this.config = _ext(config, {
		x : 0,
		y : 0,
		fillStyle : '#CCCCCC',
		strokeStyle : '#000000',
		text : '',
		lineWidth : 0,
		rotateAngle : 0,
		scaleX : 1,
		scaleY : 1,
		globalAlpha : 1
	});
	this.events = new cvsEventObject(this);
}
CanvasGenericElement.prototype = {
	each : function(callback){
		var i = 0, len = this.children.length;
		for(; i < len; i++){
			if(callback(this.children[i], i, len)) break;
		}
	},
	append : function(el){
		if(!this.ownerDocument || !el.ownerDocument || this.ownerDocument !== el.ownerDocument)
			throw 'Different ownerDocument';
		if(el.parent) el.parent.remove(el);
		el.parent = this;
		this.children.push(el);
	},
	removeAt : function(idx){
		if(idx < 0 || idx >= this.children.length) return;
		this.children[idx].parent = null;
		delete this.children[idx].parent;
		return this.children.splice(idx, 1);
	},
	remove : function(el){
		var idx = -1;
		this.each(function(_el, i){
			if(_el === el){
				idx = i;
				return true;
			}
		});
		this.removeAt(idx);
	},
	clear : function(){
		this.each(function(el){
			el.parent = null;
			delete el.parent;
		})
		this.children = [];
	},
	hasChild : function(el){
		var n = el.parent;
		while(!!n){
			if(n === this) return true;
			n = n.parent;
		}
		n = null;
		return false;
	},
	draw : function(ctx){

		ctx.save();

		ctx.translate(this.config.x, this.config.y);
		ctx.rotate(this.config.rotate);
		ctx.scale(this.config.scaleX, this.config.scaleY);

		this.path(ctx);
		this.fill(ctx);
		this.stroke(ctx);
		//this.text(ctx);

		ctx.restore();

		var i = 0, len = this.children.length;
		for(; i < len; i++){
			this.children[i].draw(ctx);
		}
	},
	moveTo : function(x, y){
		this.config.x = x;
		this.config.y = y;
		return this;
	},
	scale : function(x, y){
		this.config.scaleX = x;
		this.config.scaleY = y;
		return this;
	},
	rotate : function(deg){
		this.config.rotate = deg * Math.PI / 180;
		return this;
	},
	content : function(str){
		this.config.text = str;
		return this;
	},
	fill : function(ctx){
		ctx.fillStyle = this.config.fillStyle;
		ctx.fill();
	},
	stroke : function(ctx){
		ctx.lineWidth = this.config.lineWidth;
		ctx.strokeStyle = this.config.strokeStyle;
		ctx.stroke();
	},
	color : function(c){
		this.config.fillStyle = c;
		return this;
	},
	border : function(w, c){
		this.config.strokeStyle = c || this.config.strokeStyle;
		this.config.borderWidth = w || this.config.borderWidth;
		return this;
	},
	opacity : function(v){
		this.config.globalAlpha = v;
		return this;
	},
	path : function(ctx){ throw 'Notcompliment'; },
	text : function(ctx){ throw 'Notcompliment'; },
	check : function(x, y){ throw 'Notcompliment'; },
	capture : function(x, y){
		var tmp = null
		if(!this.check(x, y)) return tmp;
		var i = this.children.length;
		while(--i >= 0){
			tmp = this.children[i].capture(x, y);
			if (!!tmp) return tmp;
		}
		return this;
	},
	bubble : function(eventName){

	},
	mousedown : function(callback){
		this.events.regist('mousedown', callback);
	},
	mouseup : function(callback){
		this.events.regist('mouseup', callback);
	}
}



var Panel = _inherit('Panel', CanvasGenericElement, {
	path : function(ctx){
		var h = this.config.width * .5;
		var v = this.config.height * .5;
		ctx.beginPath();
		ctx.rect(
			this.config.width * -.5,
			this.config.height * -.5,
			this.config.width,
			this.config.height
			);
	},
	size : function(w, h){
		this.config.width = w;
		this.config.height = h;
		return this;
	},
	check : function(x, y){
		return x >= this.config.x
			&& x <= this.config.x + this.config.width
			&& y >= this.config.y
			&& y <= this.config.y + this.config.height;	
	}
}, { config : { width : 100, height : 100 } });

var Circle = _inherit('Circle', CanvasGenericElement, {
	path : function(ctx){
		ctx.beginPath();
		ctx.arc(0, 0, this.config.radio, 0, Math.PI * 2, false);
	},
	size : function(r){
		this.config.radio = r;
		return this;
	},
	check : function(x, y){
		x = this.config.x - x;
		y = this.config.y - y;
		var d2 = x * x + y * y, r = this.config.radio;
		return d2 < r * r;
	}
}, { config : { radio : 50 } })

function CanvasDocument(id){
	CanvasGenericElement.call(this, {});
	var cvs = typeof id === 'string' ? document.getElementById(id) : cvs;
	if(!cvs) cvs = document.createElement('canvas');
	this.context = cvs.getContext('2d');
	this.ownerDocument = this;
}
CanvasDocument.prototype = new CanvasGenericElement();
CanvasDocument.prototype.createPanel = function(){
	var p = new Panel();
	p.ownerDocument = this;
	return p;
}
CanvasDocument.prototype.createCircle = function(){
	var p = new Circle();
	p.ownerDocument = this;
	return p;
}
CanvasDocument.prototype.draw = function(){
	this.context.clearRect(0, 0, this.context.canvas.width, this.context.canvas.height);
	var i = this.children.length;
	while(--i >= 0){
		this.children[i].draw(this.context);
	}
}

w.CanvasGenericElement = CanvasGenericElement;
w.CanvasDocument = CanvasDocument;

})(window);

var doc = new CanvasDocument('test');
console.log(doc)
var b = doc.createPanel();
var b2 = doc.createPanel();
var b3 = doc.createPanel();
var c = doc.createCircle();
var c2 = doc.createCircle();
var c3 = doc.createCircle();
b.config.fillStyle = 
b2.config.fillStyle = 
b3.config.fillStyle = 
c.config.fillStyle =
c2.config.fillStyle =
c3.config.fillStyle =
'rgba(0,0,0,0.2)';
//'rgba(0,0,0,0)';

b.moveTo(300, 200)
b2.moveTo(300, 200)
b3.moveTo(300, 200)
c.moveTo(300, 200)
c2.moveTo(300, 200)
c3.moveTo(300, 200)

doc.append(c);
doc.append(c2);
doc.append(c3);
doc.append(b);
doc.append(b2);
doc.append(b3);

c.scale(1, .5);
c2.scale(1, 2);
c3.scale(1, 1.5);
b.size(200, 200);
b2.size(200, 200);
b3.size(200, 200);

var deg = 0;
var scale = 1;
setInterval(function(){
	deg = (deg + 1) % 180;
	scale = Math.cos(deg * Math.PI / 180);
	b.rotate(deg).scale(scale, scale);
	b2.rotate(-deg + 30).scale(scale, scale);
	b3.rotate(deg * 2).scale(scale, scale);

	scale = Math.sin(deg * Math.PI / 180);
	c.size(scale * 50).rotate(deg);
	c2.size(scale * 70).rotate(-deg - 30);
	c3.size(scale * 90).rotate(deg - 60);

	doc.draw();
}, 30)


</script>


</body>


</html>